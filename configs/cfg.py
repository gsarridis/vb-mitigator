from yacs.config import CfgNode as CN
from tools.utils import log_msg


def show_cfg(cfg, logger):
    dump_cfg = CN()
    dump_cfg.EXPERIMENT = cfg.EXPERIMENT
    dump_cfg.MODEL = cfg.MODEL
    dump_cfg.DATASET = cfg.DATASET
    dump_cfg.MITIGATOR = cfg.MITIGATOR
    dump_cfg.SOLVER = cfg.SOLVER
    dump_cfg.LOG = cfg.LOG
    if cfg.MITIGATOR.TYPE in cfg:
        dump_cfg.update({cfg.MITIGATOR.TYPE: cfg.get(cfg.MITIGATOR.TYPE)})
    log_msg("CONFIG:\n{}".format(dump_cfg.dump()), "INFO", logger)


CFG = CN()
# Experiment
CFG.EXPERIMENT = CN()
CFG.EXPERIMENT.PROJECT = "biased_mnist"
CFG.EXPERIMENT.NAME = "dev"
CFG.EXPERIMENT.TAG = "vanilla"
CFG.EXPERIMENT.GPU = "cuda:0"  # or cpu
CFG.EXPERIMENT.SEED = 1
# Model
CFG.MODEL = CN()
CFG.MODEL.TYPE = "resnet"

# Solver
CFG.SOLVER = CN()
CFG.SOLVER.BATCH_SIZE = 64
CFG.SOLVER.EPOCHS = 240
CFG.SOLVER.LR = 0.05
CFG.SOLVER.WEIGHT_DECAY = 0.0001
CFG.SOLVER.MOMENTUM = 0.9
CFG.SOLVER.TYPE = "SGD"
CFG.SOLVER.CRITERION = "CE"
CFG.SOLVER.SCHEDULER = CN()
CFG.SOLVER.SCHEDULER.TYPE = "MultiStepLR"
CFG.SOLVER.SCHEDULER.LR_DECAY_STAGES = [150, 180, 210]
CFG.SOLVER.SCHEDULER.LR_DECAY_RATE = 0.1
# Log
CFG.LOG = CN()
CFG.LOG.TENSORBOARD_FREQ = 500
CFG.LOG.SAVE_CHECKPOINT_FREQ = 40
CFG.LOG.PREFIX = "./output"
CFG.LOG.WANDB = False
CFG.LOG.TRAIN_PERFORMANCE = False
CFG.LOG.SAVE_CRITERION = "val"

CFG.METRIC = "acc"
# Dataset
CFG.DATASET = CN()
CFG.DATASET.TYPE = "cifar100"
CFG.DATASET.NUM_WORKERS = 8
CFG.DATASET.TEST = CN()
CFG.DATASET.TEST.BATCH_SIZE = 64
CFG.DATASET.BIASES = [
    "color",
    "blonde",
    "makeup",
    "race",
    "age",
    "background",
    "bgcolor",
    "fg_color",
]


# Dataset specific arguements
CFG.DATASET.BIASED_MNIST = CN()
CFG.DATASET.BIASED_MNIST.RATIO = 0
CFG.DATASET.BIASED_MNIST.CORR = 0.99
CFG.DATASET.BIASED_MNIST.ROOT = "./data/biased_mnist"

# Dataset specific arguements
CFG.DATASET.FB_BIASED_MNIST = CN()
CFG.DATASET.FB_BIASED_MNIST.RATIO = 0
CFG.DATASET.FB_BIASED_MNIST.CORR_BG = 0.9
CFG.DATASET.FB_BIASED_MNIST.CORR_FG = 0.9
CFG.DATASET.FB_BIASED_MNIST.ROOT = "./data/fb_biased_mnist"

# Dataset specific arguements
CFG.DATASET.UTKFACE = CN()
CFG.DATASET.UTKFACE.BIAS = "race"
CFG.DATASET.UTKFACE.ROOT = "./data/utkface"
CFG.DATASET.UTKFACE.RATIO = 0
CFG.DATASET.UTKFACE.IMAGE_SIZE = 64
# MITIGATOR
CFG.MITIGATOR = CN()
CFG.MITIGATOR.TYPE = "erm"  # Vanilla as default
# MAVias CFG
CFG.MITIGATOR.MAVIAS = CN()
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL = CN()
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL.TYPE = "ram"
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL.IMG_SIZE = 384
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL.BATCH_SIZE = 32
CFG.MITIGATOR.MAVIAS.ENCODER = CN()
CFG.MITIGATOR.MAVIAS.ENCODER.TYPE = "clip"
CFG.MITIGATOR.MAVIAS.ENCODER.SIZE = 768
CFG.MITIGATOR.MAVIAS.LLM = CN()
CFG.MITIGATOR.MAVIAS.LLM.TYPE = "llama3"
CFG.MITIGATOR.MAVIAS.LLM.BATCH_SIZE = 100
CFG.MITIGATOR.MAVIAS.LOSS = CN()
CFG.MITIGATOR.MAVIAS.LOSS.ALPHA = 0.01
CFG.MITIGATOR.MAVIAS.LOSS.LAMBDA = 0.4
CFG.MITIGATOR.MAVIAS.PROJNET = CN()
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM = CN()

CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.LR = 0.001
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.WEIGHT_DECAY = 5e-4
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.MOMENTUM = 0.9
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.TYPE = "SGD"

# FLAC CFG
CFG.MITIGATOR.FLAC = CN()
CFG.MITIGATOR.FLAC.LOSS = CN()
CFG.MITIGATOR.FLAC.LOSS.ALPHA = 110.0
CFG.MITIGATOR.FLAC.LOSS.DELTA = 0.5

# BADD CFG
CFG.MITIGATOR.BADD = CN()
CFG.MITIGATOR.BADD.M = 1.0
